#!/usr/bin/env bash

# Nix-polyglot development environment with smart glot CLI caching
use flake

# Smart caching: rebuild glot if flake.lock is newer than cached binary
CACHE_FILE=".cache/bin/glot"
if [[ ! -f "$CACHE_FILE" ]] || [[ "flake.lock" -nt "$CACHE_FILE" ]]; then
    echo "üì¶ Setting up glot CLI..."
    mkdir -p .cache/bin
    if nix build .#glot -o .cache/glot-link 2>/dev/null; then
        cp .cache/glot-link/bin/glot "$CACHE_FILE"
        chmod +x "$CACHE_FILE"
        rm .cache/glot-link
        echo "‚úÖ glot CLI ready"
    else
        echo "‚ö†Ô∏è  Could not build glot CLI - using system version if available"
    fi
fi

# Add cached glot to PATH
export PATH=".cache/bin:$PATH"

# Install git hooks if needed
if [[ -d .git ]] && [[ ! -f .git/hooks/pre-commit ]]; then
    echo "üîó Installing git hooks..."
    if command -v glot >/dev/null 2>&1; then
        glot install-hooks >/dev/null 2>&1 || echo "‚ö†Ô∏è  Could not install git hooks"
    fi
fi

# Install shell completions if glot is available
if command -v glot >/dev/null 2>&1; then
    # Check if completions are already installed by looking for glot completion files
    SHELL_NAME=$(basename "$SHELL")
    case "$SHELL_NAME" in
        bash)
            COMPLETION_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/bash_completion.d"
            COMPLETION_FILE="$COMPLETION_DIR/glot"
            ;;
        zsh)
            COMPLETION_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/zsh/completions"
            COMPLETION_FILE="$COMPLETION_DIR/_glot"
            ;;
        fish)
            COMPLETION_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/fish/completions"
            COMPLETION_FILE="$COMPLETION_DIR/glot.fish"
            ;;
        *)
            COMPLETION_DIR=""
            COMPLETION_FILE=""
            ;;
    esac
    
    if [[ -n "$COMPLETION_FILE" ]] && [[ ! -f "$COMPLETION_FILE" ]]; then
        echo "üöÄ Setting up shell completions for $SHELL_NAME..."
        glot install-completions >/dev/null 2>&1 || echo "‚ö†Ô∏è  Could not install completions (you can run 'glot install-completions' manually)"
    fi
fi
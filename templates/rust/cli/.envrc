#!/usr/bin/env bash

# Nix-polyglot development environment with smart glot CLI caching
use flake

# Smart caching: rebuild glot if flake.lock is newer than cached binary
CACHE_FILE=".cache/bin/glot"
if [[ ! -f "$CACHE_FILE" ]] || [[ "flake.lock" -nt "$CACHE_FILE" ]]; then
    echo "üì¶ Setting up glot CLI..."
    mkdir -p .cache/bin
    if nix build .#glot -o .cache/glot-link 2>/dev/null; then
        cp .cache/glot-link/bin/glot "$CACHE_FILE"
        chmod +x "$CACHE_FILE"
        rm .cache/glot-link
        echo "‚úÖ glot CLI ready"
    else
        echo "‚ö†Ô∏è  Could not build glot CLI - using system version if available"
    fi
fi

# Add cached glot to PATH
export PATH=".cache/bin:$PATH"

# Install git hooks if needed
if [[ -d .git ]] && [[ ! -f .git/hooks/pre-commit ]]; then
    echo "üîó Installing git hooks..."
    if command -v glot >/dev/null 2>&1; then
        glot install-hooks >/dev/null 2>&1 || echo "‚ö†Ô∏è  Could not install git hooks"
    fi
fi